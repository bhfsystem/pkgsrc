#!/usr/bin/env bash

function bootstrap {
  local shome="$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"
  source "$shome/script/profile"

  if [[ ! -d "$shome/vendor/pkgsrc-mirror" ]]; then
    if [[ -f /data/git/pkgsrc-mirror.tar.gz ]]; then
      cd "$shome"
      tar xvfz /data/git/pkgsrc-mirror.tar.gz
      cd vendor/pkgsrc-mirror
      git fetch origin "${PKGSRC_BRANCH}"
    else
      git clone --bare --depth 1 -b "${PKGSRC_BRANCH}" git@github.com:jsonn/pkgsrc "$shome/vendor/pkgsrc-mirror"
    fi
  fi

  if [[ -d "$shome/vendor/pkgsrc" ]]; then
    (cd $shome/vendor/pkgsrc; git checkout -b "${PKGSRC_BRANCH}")
  else
    git clone --depth 1 -b "${PKGSRC_BRANCH}" "file://$shome/vendor/pkgsrc-mirror"  "$shome/vendor/pkgsrc"
  fi

  "$shome/script/update"

  if [[ -n "${PKG_HOME:-}" ]]; then
    if [[ ! -d "${PKG_HOME}" ]]; then
      if ! install -d -o "$(id -un)" -g "$(id -gn)" "${PKG_HOME}"; then
        sudo install -d -o "$(id -un)" -g "$(id -gn)" "${PKG_HOME}" || true
      fi
    fi
    pkg ensure bootstrap

		case "$(uname -s)" in
			Darwin)
        set +u

        pkg ensure devel/ncurses || true
        pushd "${WRKOBJDIR}/devel/ncurses/work"/ncurses-*
        make
        popd
        pkg ensure devel/ncurses

        pushd "${PKG_HOME}/install/include"
        ln -nfs gettext/libintl.h .
        popd

        pkg ensure devel/gettext-tools || true
        pushd "${WRKOBJDIR}/devel/gettext-tools/work"/gettext-*
        env CWRAPPERS_CONFIG_DIR=$(pwd)/../.cwrapper/config bmake
        popd
        pkg ensure devel/gettext-tools

        pkg ensure devel/gettext || true
        cd "${WRKOBJDIR}/devel/gettext/work"/gettext-*
        env CWRAPPERS_CONFIG_DIR=$(pwd)/../.cwrapper/config bmake
        popd
        pkg ensure devel/gettext

        set -u
				;;

      Linux)
        pkg ensure devel/ncurses
        pkg ensure devel/gettext-tools
        pkg ensure devel/gettext
        ;;
    esac

    pkg ensure pkgtools/pkgin
    pkg ensure pkgtools/pkg_chk

    pkgin update
  fi
}

bootstrap
