#!/usr/bin/env bash

function bootstrap {
  local shome="${_pkgsrc_home:-"$(cd -P -- "$(dirname -- "$BASH_SOURCE")/.." && pwd -P)"}"
  source "$shome/script/profile"

  if [[ -d "$shome/vendor/pkgsrc" ]]; then
    git checkout -b "${PKGSRC_BRANCH}"
  else
    git clone --depth 1 -b "${PKGSRC_BRANCH}" git@github.com:jsonn/pkgsrc "$shome/vendor/pkgsrc" || true
  fi

  mkdir -p "$(dirname "${DISTDIR}")" || sudo install -d -o $(id -un) -g $(id -gn) "$(dirname "${DISTDIR}")"
  mkdir -p "$DISTDIR" "$PACKAGES"

  if [[ -n "${PKG_HOME:-}" ]]; then
    if [[ ! -d "${PKG_HOME}" ]]; then
      if ! install -d -o "$(id -un)" -g "$(id -gn)" "${PKG_HOME}"; then
        sudo install -d -o "$(id -un)" -g "$(id -gn)" "${PKG_HOME}" || true
      fi
    fi
    pkg ensure bootstrap
    pkg ensure pkgtools/pkg_rolling-replace
    pkg ensure pkgtools/pkg_chk
    pkg ensure pkgtools/pkg_tarup
    #pkg ensure pkgtools/pkgin
  fi
}

bootstrap
